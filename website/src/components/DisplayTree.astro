<div class="tree-container">
    <div id="tree"></div>
    <div class="error-message"></div>
</div>


<script lang="ts">
    const tree = new URLSearchParams(window.location.search).get('tree');
    const messageDiv = document.querySelector('.error-message');

    async function loadTreeData() {
        try {
            const response = await fetch(`/api/tree?tree=${tree}`, {
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json();
                if (messageDiv) {
                    messageDiv.textContent = errorData.detail || 'Failed to retrieve data';
                    messageDiv.style.color = 'red';
                }
                return null;
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error loading tree:', error);
            if (messageDiv) {
                messageDiv.textContent = 'An error occurred';
                messageDiv.style.color = 'red';
            }
            return null;
        }
    }

    async function loadLibraryAndInit() {
        const script = document.createElement('script');
        script.src = 'https://cdn.balkan.app/familytree.js';
        script.onerror = () => console.error('Failed to load FamilyTree library');
        script.onload = async () => {
            const data = await loadTreeData();
            if (!data) return;

            const container = document.getElementById("tree");
            let processedNodes = data.map(node => {
                const id = Number(node.id);
                if (isNaN(id) || id === 0) {
                    console.error(`Skipping node due to invalid primary ID: ${node.id}`, node);
                    return null;
                }
                return {
                    id: id,
                    Name: node.Name,
                    gender: node.gender,
                    'Birth Date': node['Birth Date'],
                    'Birth Place': node['Birth Place'],
                    'Death Date': node['Death Date'],
                    'Death Place': node['Death Place'],
                    Occupation: node.Occupation,
                    mid: node.mid ? Number(node.mid) : undefined,
                    fid: node.fid ? Number(node.fid) : undefined,
                    pids: node.pids ? node.pids.map(pid => Number(pid)).filter(pid => !isNaN(pid) && pid !== 0) : []
                };
            }).filter(node => node !== null);

            console.log('Raw API data:', data);

            let previousNodeCount;
            let currentNodeCount = processedNodes.length;
            do {
                previousNodeCount = currentNodeCount;
                const currentValidIds = new Set(processedNodes.map(n => n.id));

                processedNodes = processedNodes.filter(node => {
                    let isValid = true;

                    if (node.mid !== undefined && (!currentValidIds.has(node.mid) || isNaN(node.mid) || node.mid === 0)) {
                        console.warn(`Node ${node.id} removed: invalid mother ID ${node.mid}.`);
                        isValid = false;
                    }
                    if (node.fid !== undefined && (!currentValidIds.has(node.fid) || isNaN(node.fid) || node.fid === 0)) {
                        console.warn(`Node ${node.id} removed: invalid father ID ${node.fid}.`);
                        isValid = false;
                    }
                    if (node.pids && node.pids.length > 0) {
                        const originalPidsLength = node.pids.length;
                        node.pids = node.pids.filter(pid => currentValidIds.has(pid) && !isNaN(pid) && pid !== 0);
                        if (node.pids.length !== originalPidsLength) {
                        }
                    }

                    return isValid;
                });
                currentNodeCount = processedNodes.length;

                console.log(`Loop iteration: previous=${previousNodeCount}, current=${currentNodeCount}`);
            } while (currentNodeCount < previousNodeCount);

            const validatedData = processedNodes;
            const finalValidIds = new Set(validatedData.map(n => n.id));



            const rootNode = validatedData.length > 0 ? validatedData[0] : null;
            if (!rootNode) {
                console.error('CRITICAL ERROR: No nodes found in validated data. Tree initialization aborted.');
                messageDiv.textContent = 'No data available, cannot render tree.';
                messageDiv.style.color = 'red';
                return;
            }

            try {
                const tree = new FamilyTree(container, {
                    mode: 'dark',
                    layout: FamilyTree.layout.mixed,
                    nodes: validatedData,
                    template: 'hugo',
                    nodeBinding: {
                        field_0: 'Name',
                        field_1: 'Birth Date'
                    },
                    editForm: {
                        readOnly: true
                    },
                    nodeMouseClick: FamilyTree.action.details
                });
                tree.onInit(() => {
                    tree.center(1);
                });
            } catch (e) {
                console.error('FamilyTree initialization error:', e);
                messageDiv.textContent = 'Unknown Error Occured: Check Console for details.';
                messageDiv.style.text = 'red';

            }
        };
        document.head.appendChild(script);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadLibraryAndInit);
    } else {
        loadLibraryAndInit();
    }
</script>