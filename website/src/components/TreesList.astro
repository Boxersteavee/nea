<div class="container">
    <div class="form">
        <h2>Your Trees</h2>
        <div id="trees-list">
            <p>Loading...</p>
        </div>
        <div class="error-message" id="trees-error-message"></div>
    </div>
</div>

<script>
    const treesList = document.getElementById('trees-list');
    const messageDiv = document.getElementById('trees-error-message');

    async function loadTrees() {
        if (!treesList || !messageDiv) return;

        try {
            const response = await fetch('/api/trees', {
                credentials: 'include'
            });

            if (!response.ok) {
                const data = await response.json();
                messageDiv.textContent = data.detail || 'Failed to load trees';
                messageDiv.style.color = 'red';
                treesList.innerHTML = '';
                return;
            }

            const data = await response.json();

            if (data.trees && data.trees.length > 0) {
                treesList.innerHTML = data.trees
                    .map((tree: string) =>
                        `
                        <div class="tree-item">
                            <a href="/tree?tree=${encodeURIComponent(tree)}">
                                <button type="button">${tree}</button>
                            </a>
                            <button type="button" class="delete-btn" data-tree="${tree}">Delete</button>
                        </div>
                        `
                    )
                    .join('');
                messageDiv.textContent = '';
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', handleDelete);
                });
            } else {
                treesList.innerHTML = '<p>No trees uploaded yet.</p>';
                messageDiv.textContent = '';
            }
        } catch (error) {
            console.error('Error loading trees:', error);
            messageDiv.textContent = 'An error occurred';
            messageDiv.style.color = 'red';
            treesList.innerHTML = '';
        }
    }

    async function handleDelete(event: Event) {
        const button = event.target as HTMLButtonElement;
        const tree = button.dataset.tree;

        try {
            const response = await fetch(`/api/tree/delete?tree=${encodeURIComponent(tree)}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!response.ok) {
                const data = await response.json();
                messageDiv.textContent = data.detail || 'Failed to delete tree';
                messageDiv.style.color = 'red';
                return;
            }

            messageDiv.textContent = 'Tree Deleted Successfully';
            messageDiv.style.color = 'green';

            await loadTrees();
        } catch (error) {
            console.error('Error loading trees:', error);
            messageDiv.textContent = `An error occurred while deleting "${tree}", see console for details.`;
            messageDiv.style.color = 'red';
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTrees);
    } else {
        loadTrees();
    }
</script>
