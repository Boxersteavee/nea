<div class="tree-container">
    <div id="tree"></div>
    <div class="error-message"></div>
</div>


<script lang="ts">
    // AI Models from GitHub Copilot were used to assist with the logic and syntax of this section.

    // Define tree variable as the value from the search parameter (?tree={value} in URL)
    const tree = new URLSearchParams(window.location.search).get('tree');
    // Define messageDiv as the error-message box div in the HTML above.
    const messageDiv = document.querySelector<HTMLDivElement>('.error-message');

    // This function loads the data about the tree from the API.
    async function loadTreeData() {
        // Try statement to catch any errors that occur during the retrieval
        try {
            // Get data from the API, using the tree variable as the tree to get data for
            const response = await fetch(`/api/tree?tree=${tree}`, {
                credentials: 'include'
            });

            // If the response is anything but 200 OK, print the error to the console,
            // and print the error to messageDiv if it exists in red text.
            if (!response.ok) {
                const error = await response.json();
                console.log(error);
                if (messageDiv) {
                    messageDiv.textContent = error.detail || 'Failed to retrieve data';
                    messageDiv.style.color = 'red';
                }
                return null;
            }

            // If there's no errors, set data to the response and return data.
            const data = await response.json();
            return data;
        // If any other errors occur, print the error to the console and print a message in the messageDiv
        } catch (error) {
            console.error('Error loading tree:', error);
            if (messageDiv) {
                messageDiv.textContent = 'An error occurred';
                messageDiv.style.color = 'red';
            }
            return null;
        }
    }

    // This function loads the FamilyTreeJS library from Balkan, tells it how to process the data and gives the data to it.
    async function loadLibraryAndInit() {
        // define script as a new element and set the source to the URL for balkan's library.
        const script = document.createElement('script');
        script.src = 'https://cdn.balkan.app/familytree.js';
        // Set an onerror watch which prints en error to the console and to the messageDiv if the library fails to load
        script.onerror = () => {
            console.error('Failed to load FamilyTree library');
            messageDiv.textContent = 'Failed to load FamilyTree library';
            messageDiv.style.color = 'red';
            };

        // Codeblock to initialise the library and send the data to it.
        script.onload = async () => {
            // Get the data from loadTreeData, exit if there is no data (if an error caused it to be set to null)
            const data = await loadTreeData();
            if (!data) return;
            // Print raw data to console log for debugging
            console.log('Raw API data:', data);

            // Define container as the 'tree' element, which is the box the tree can be in.
            const container = document.getElementById("tree");

            const rootNode = data.length > 0 ? data[0] : null;
            if (!rootNode) {
                console.error('CRITICAL ERROR: No nodes found in data. Tree initialization aborted.');
                messageDiv.textContent = 'No data available, cannot render tree.';
                messageDiv.style.color = 'red';
                return;
            }

            try {
                const tree = new FamilyTree(container, {
                    mode: 'dark',
                    layout: FamilyTree.layout.normal,
                    nodes: data,
                    template: 'hugo',
                    nodeBinding: {
                        field_0: 'Name',
                        field_1: 'Birth Date'
                    },
                    editForm: {
                        readOnly: true
                    },
                    nodeMouseClick: FamilyTree.action.details
                });

                tree.on('error', (sender, args) => {
                    console.error('FamilyTree initialisation error:', args);
                    if (messageDiv) {
                        messageDiv.textContent = 'Unknown Error Occurred. Check Console for details.';
                        messageDiv.style.color = 'red';
                    }
                });

                tree.onInit(() => {
                    tree.center(1);
                });
            } catch (e) {
                console.error('FamilyTree initialisation error:', e);
                messageDiv.textContent = 'Unknown Error Occurred: Check Console for details.';
                messageDiv.style.color = 'red';
            }
        };
        document.head.appendChild(script);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadLibraryAndInit);
    } else {
        loadLibraryAndInit();
    }
</script>